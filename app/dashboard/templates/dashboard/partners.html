{% extends 'dashboard/base.html' %}

{% load bootstrap3 %}

{% load static %}

{% block bootstrap3_extra_head %}    
    <!-- leaflet css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
        integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin=""/>
    
    <!-- dashboard css -->
    <link rel="stylesheet" href="{% static 'dashboard/dashboard.css' %}"/>
{% endblock %}

{% block title %}Our Partners & Coverage -{% endblock %}

{% block content %}
    <h3>Our Partners</h3>
    <p>Data displayed on Air Quality Chicago is a collaborative effort of ELPC, public health allies, and community organizations. Our partners include:</p>
   
    <table class="table table-sm text-center partners">
        <tbody>
            <tr>
                <td><a href="https://experimentalstation.org/market/" title="61st Street Farmers Market"><img src="{% static 'dashboard/img/61stStreetFarmersMarket.jpg' %}"></img></a></td>
                <td><a href="https://www.facebook.com/GreenerSouthLoop/" title="Alliance for a Greener South Loop"><img src="{% static 'dashboard/img/AGreenerSouthLoop.png' %}"></img></a></td>
                <td><a href="https://experimentalstation.org/blackstone/" title="Blackstone Bicycle Works"><img src="{% static 'dashboard/img/BlackstoneBicycleWorks.jpg' %}"></img></a></td>
                <td><a href="http://cps.edu" title="Chicago Public Schools"><img src="{% static 'dashboard/img/ChicagoPublicSchools.jpg' %}"></img></a></td>
            </tr>
            <tr>
                <td><a href="http://cutcatscourier.com/" title="Cut Cats Courier"><img src="{% static 'dashboard/img/CutCatsCourier.png' %}"></img></a></td>
                <td><a href="https://delta-institute.org/" title="Delta Institute"><img src="{% static 'dashboard/img/DeltaInstitute.jpg' %}"></img></a></td>
                <td><a href="http://elpc.org/" title="ELPC"><img src="{% static 'dashboard/img/ELPC.jpg' %}"></img></a></td>
                <td><a href="https://experimentalstation.org/" title="Experimental Station"><img src="{% static 'dashboard/img/ExperimentalStation.jpg' %}"></img></a></td>
            </tr>
            <tr>
                <td><a href="http://habitatmap.org/" title="Habitat Map"><img src="{% static 'dashboard/img/HabitatMap.png' %}"></img></a></td>
                <td><a href="http://justdesign.coop/" title="JustDesign Cooperative, LLC"><img src="{% static 'dashboard/img/JustDesign.png' %}"></img></a></td>
                <td><a href="https://www.fieldmuseum.org/science/research/area/keller-science-action-center" title="Keller Science Action Center"><img src="{% static 'dashboard/img/FieldMuseum.jpg' %}"></img></a></td>
                <td><a href="https://experimentalstation.org/linkup-overview/" title="LINK Up Illinois"><img src="{% static 'dashboard/img/LinkUpIllinois.jpg' %}"></img></a></td>

            </tr>
            <tr>
                <td><a href="https://www.mapscorps.org/" title="MAPSCorps"><img src="{% static 'dashboard/img/MapsCorps.jpg' %}"></img></a></td>
                <td><a href="http://www.patagonia.com/" title="Patagonia"><img src="{% static 'dashboard/img/Patagonia.jpg' %}"></img></a></td>
                <td><a href="http://plantchicago.org/" title="Plant Chicago"><img src="{% static 'dashboard/img/PlantChicago.png' %}"></img></a></td>
                <td><a href="http://setaskforce.org/" title="Southeast Environmental Task Force"><img src="{% static 'dashboard/img/SETaskForce.jpg' %}"></img></a></td>
            </tr>
			<tr>
                <td><a href="https://www.msichicago.org/" title="Museum of Science and Industry"><img src="{% static 'dashboard/img/MSIlogo.jpg' %}"></img></a></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tbody>
    </table>
    
    <h3>Our Coverage</h3>
    
    <div id="id_map">
    </div>
{% endblock %}

{% block bootstrap3_extra_script %}
    <!-- leaflet js -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
       integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
       crossorigin="">
    </script>
    
    <!-- leaflet easyPrint -->
    <script src=" https://cdn.rawgit.com/rowanwins/leaflet-easyPrint/gh-pages/dist/bundle.js">
    </script>
   
    <!-- leaflet omnivore -->
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
    
    <!-- leaflet spin -->
    <script src="https://cdn.rawgit.com/makinacorpus/Leaflet.Spin/gh-pages/spin/spin.js" charset="utf-8"></script>
    <script src="https://cdn.rawgit.com/makinacorpus/Leaflet.Spin/gh-pages/leaflet.spin.min.js" charset="utf-8"></script>
    
    <!-- dashboard functions -->
    <script src="{% static 'dashboard/dashboard.js' %}"  type="text/javascript">
    </script>
    
    <!-- jquery cookie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

    <script>
        /*----------------------------------------------------------------------------
          global vars setup
         *----------------------------------------------------------------------------*/    
        var geoType = geoTypes.HEXAGONS;
        
        var counts = [];
        
        /*----------------------------------------------------------------------------
          map setup
         *----------------------------------------------------------------------------*/
        var attribution = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>';
        var accessToken = 'pk.eyJ1IjoiZHJ3YWhsIiwiYSI6ImNqOG9zN25nYTA3dG8ycXJzNGpqbmE3cTgifQ.mNd1sk4ymlt8lvZTwKADOA';
        
        // tile layers
        var streets = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            attribution: attribution,
            id: 'mapbox.streets',
            accessToken: accessToken,
        });
        
        var light = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            attribution: attribution,
            id: 'mapbox.light',
            accessToken: accessToken,
        });
        
        // layer groups
        var geo = L.layerGroup([]);
        
        // map
        var map = L.map('id_map', {
            center: [41.8781, -87.6298],
            zoom: 13,
            maxZoom: 17,
            minZoom: 11,
            preferCanvas: true,
            layers: [streets, geo],
        });
        
        // control layers
        var baseMaps = {
            "Streets": streets,
            "Light": light,
        };
        
        var overlayMaps = {
            "Geo": geo,
        };
        
        L.control.layers(baseMaps, overlayMaps).addTo(map);
        
        var printPlugin = L.easyPrint({
      		sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
      		filename: 'map',
      		exportOnly: true,
      		hideControlContainer: true
		}).addTo(map);
		
	    // legend       
	    var legend = L.control({position: 'bottomright'});

	    legend.onAdd = function(map) {
		    var div = L.DomUtil.create('div', 'info legend'),
			    labels = [],
			    from, to;
			
			var coverageLevels = [0.0, 0.2, 0.4, 0.6, 0.8];

		    for (var i = 0; i < coverageLevels.length; i++) {
			    from = coverageLevels[i];
			    to = coverageLevels[i + 1];
			    
			    labels.push(
				    '<i style="background:' + coverageColor + '; ' + 
				    'opacity:' + coverageLevels[i]*maxOpacity +'"></i> ' +
				    from + (to ? '–' + to : '+'));
		    }

		    div.innerHTML = labels.join('<br>');
		    return div;
	    };

	    legend.addTo(map);
        /*----------------------------------------------------------------------------
          document ready callback
         *----------------------------------------------------------------------------*/   
        $(document).ready(function() {
            //console.log("ready");
            
            // get averages
            $.getJSON("{% static 'dashboard/counts.json' %}", countsCallback);
            
            // start spin
            map.spin(true);
        });
        
        /*----------------------------------------------------------------------------
          counts data callback
         *----------------------------------------------------------------------------*/
        function countsCallback(data) {
            counts = data['counts'];
            //console.log(counts);
            
            // geo type callback
            var cb = geoTypes.properties[geoType].cb;
            if(cb) {
                cb([], geoCallback);
            }
        }
        
        /*----------------------------------------------------------------------------
          geo data callback
         *----------------------------------------------------------------------------*/
        function geoCallback(data) {
            // check geo type
            var table = geoTypes.properties[geoType].table;
            var geo_data = JSON.parse(data[table]);
            //console.log(geo_data);
            
            // get max count
            var data = Object.keys(counts).map(function(key) { return counts[key]; });
            var max_count = Math.max.apply(Math, data);
            //console.log(max_count);
            
            geo.clearLayers();
            
            // add to list, draw neighborhoods
            for (i = 0; i < geo_data.length; ++i) {
                // check averages
                var pk = geo_data[i]['id'];
                var display = geo_data[i]['display'];
                var value = counts[pk];
                
                // fill color
                var color = '#fff';
                var opacity = 0.0;
                if(value != undefined) {
                    color = coverageColor;
                    opacity = minOpacity + (maxOpacity - minOpacity)*value/max_count;
                }
                
                // skip default location (empty multipolygon)
                if(pk == defaultLoc) {
                    continue;
                }
                
                var multi_polygon = omnivore.wkt.parse(geo_data[i]['geo']);
                
                multi_polygon.setStyle({
                    fillColor: color,
                    fillOpacity: opacity,
                    color: '#444',
                    weight: 0,
                    opacity: 1.0,
                });
                
                // popup text
                if(value != undefined) {
                    var popup = "<table class=\"table table-bordered table-striped\"> \
                        <tr><th>Boundary</th><td>" + display + "</td></tr> \
                        <tr><th>Count</th><td>" + value.toFixed(0) + "</td></tr> \
                        </table>"
                    multi_polygon.bindPopup(popup)
                }
                
                geo.addLayer(multi_polygon);
            }
            
            // stop spin
            map.spin(false);
        }
    </script>
{% endblock %}
